= Docker for Java Developers - Instructor Setup
:toc:
:toc-placement!:

This folder contains instructions to setup an Instructor environment.

toc::[]

IMPORTANT: Make sure to run these instructions prior to the lab already. Executing them might take up to 60 minutes.

Instructor needs:

. A docker registry server
. A Boot2docker served by a local HTTP Server
. A Nexus Proxy

## Prerequisites

. Have https://www.virtualbox.org/[Oracle Virtualbox] installed and the install folder added to your PATH environment variable.
. Have the https://github.com/arun-gupta/docker-java/ git repository checked out.
. Have https://msysgit.github.io/ installed on Windows

This lab can be executed on a netbook with x86 architecture. For it to
be fun, you should have a decent hardware available. Beside the operating system of choice, there's only a couple of other thing you should have installed already:

### Hardware

. CPU
.. Mac: X64 (i5 or superior)
.. Linux / Windows: x64 (i5 and comparable)

. Memory
.. At least 8 to 16 GB

### Software

. Operating System
.. Mac OS X (10.8 or later), Windows 7 (SP1), Fedora (21 or later)
. Java
.. http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html[Oracle JDK 8u45]
.. link:http://maven.apache.org/download.cgi[Maven 3.0 or later]
. Webbrowser
.. https://www.google.com/chrome/browser/desktop/[Chrome]
.. link:http://www.getfirefox.com[Firefox]


## Install Docker Client
Docker Client allows to interact with Docker Host. Download and install by just copying and renaming it accordingly.

[source, text]
----
#Linux (Fedora only)
yum install docker-io

# MacOS / Linux (other distros)
curl -L  https://get.docker.com/builds/`uname -s`/x86_64/docker-latest > /usr/local/bin/docker
chmod +x /usr/local/bin/docker

#Windows
Download:
https://get.docker.com/builds/Windows/x86_64/docker-latest.exe
https://get.docker.com/builds/Windows/i386/docker-latest.exe
And save to c:\Users\<username>\docker\docker.exe
----

## Install Docker Compose
Docker Compose simplifies instructor's setup. The link:https://github.com/arun-gupta/docker-java/blob/master/instructor/docker-compose.yml[docker-compose.yml] contains all the instructions for the tool to setup and start the infrastructure.

Learn more about the tool on link:https://docs.docker.com/compose/[Docker Compose Website].


[source, text]
----
# Linux / MacOS
curl -L https://github.com/docker/compose/releases/download/1.3.0rc1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
----

Docker Compose is not natively supported on Windows and thus requires a workaround as specfied at http://blog.eisele.net/2015/06/docker-compose-on-windows-with-python.html.
You need to install Babun and Python to get further from here on.

## Install and Configure Docker Machine
Install the Docker machine client for your environment: https://github.com/docker/machine/releases/[latest releases]

[source, text]
----
# MacOS
curl -L  https://github.com/docker/machine/releases/download/v0.3.0-rc1/docker-machine_darwin-amd64 > /usr/local/bin/docker-machine
chmod +x /usr/local/bin/docker-machine

# Linux
curl -L https://github.com/docker/machine/releases/download/v0.3.0-rc1/docker-machine_linux-amd64 > /usr/local/bin/docker-machine
chmod +x /usr/local/bin/docker-machine

# Windows
Download:
https://github.com/docker/machine/releases/download/v0.3.0-rc1/docker-machine_windows-amd64.exe
And save to c:\Users\<username>\docker\docker-machine.exe
----

For Windows, make sure to add `c:\Users\<username>\docker` to your `%PATH%` variable. This was already done for Linux / MacOs when you downloaded `docker-machine` script to `/usr/local/bin/docker-machine`.
If you're executing commands in the Babun bash from here on, make sure to keep in mind, that the Path variable is set in Linux/Unix style:
`PATH=$PATH\:/d/Program\ Files\ \(x86\)/docker ; export PATH`. You have to escape all special characters with a backslash.


### Create Machine

. This creates your instructor host which will run the complete infrastructure.
+
[source, text]
----
docker-machine create --driver=virtualbox --virtualbox-memory=4096 mymachine
----
+
. Configure Docker client to run the commands on this newly created machine as:
+
[source, text]
----
eval "$(docker-machine env mymachine)"
----

### Virtual Box Configuration

Expose the Virtual Box ports to other computer in the LAN

VirtualBox will run docker container inside the newly create host called 'mymachine'. We need now to expose the ports used in this lab to the world.

[source, text]
----
#Open Registry Server port
VBoxManage controlvm "mymachine" natpf1 "tcp-port5000,tcp,,5000,,5000";
#Open Nexus Server port
VBoxManage controlvm "mymachine" natpf1 "tcp-port8081,tcp,,8081,,8081";
#Open HTTP Server port
VBoxManage controlvm "mymachine" natpf1 "tcp-port8082,tcp,,8082,,8082";
#Open gitlab ports
VBoxManage controlvm "mymachine" natpf1 "tcp-port10022,tcp,,10022,,10022";
VBoxManage controlvm "mymachine" natpf1 "tcp-port10080,tcp,,10080,,10080";
----

This is available as a script in https://github.com/arun-gupta/docker-java/blob/master/instructor/virtualbox-ports.sh.

Check machine IP
[source, text]
----
docker-machine ip mymachine
----

This IP address is referred as <HOST_IP> in this document.

## Configure Docker Host

Add extra args to Docker Host to allow insecure registry for external access via `http://`. You can either insert your <HOST_IP> or the complete subnet e.g. 192.168.99.100 maps to 192.168.99.0/24.

. Edit `/var/lib/boot2docker/profile` as:
+
[source, text]
----
docker-machine ssh mymachine
sudo vi /var/lib/boot2docker/profile
----
+
. Add insecure registry settings such that the file `/var/lib/boot2docker/profile` looks like:
+
[source, text]
----
EXTRA_ARGS='
--label provider=virtualbox
--insecure-registry <HOST_IP>
'
----
+
Make sure to substitute `<HOST_IP>` with the IP address obtained earlier.
+
Leave other key/value in the file as is. Save and quit the editor.
+
. Restart the docker daemon:
+
[source, text]
----
$ sudo /etc/init.d/docker restart
----
+
. Exit out of the shell by typing `exit`.

## Container with Nexus Dependencies

Create a container with Nexus dependencies.

We want to provide an option to run this lab without any Internet access. So, the instructor machine will contain everything that the attendees will need to run this lab.
[source, text]
----
docker run --name="nexusdata" -v $(pwd):/backup sonatype/nexus:oss bash -c "tar xvf  /backup/nexusbackup.tar -C /"
----

NOTE: Running Windows, make sure to copy the `nexusbackup.tar` to the following folder `c:/Users/<username>/docker-hol` and make sure to update the docker run command accordingly.
The folder permissions in Windows don't allow for a location of your choice.

This will download the Nexus image on Docker host and populate it with the Nexus dependencies.

## Start the Instructor Environment

Download link:https://devstudio.redhat.com/9.0/snapshots/builds/devstudio.product_master/2015-06-09_06-24-34-B3346/installer/[JBoss Developer Studio 9.0 - Beta2 - 482MB] and place it inside `dockerfiles/lab-httpd-server/downloads` folder.

Use the following compose command to startup the complete environment at once.

NOTE: This command should take some time to execute as it will download the required Docker images.

[source, text]
----
docker-compose up -d
----

The status of different servers can be verified as:

[source, text]
----
dockerfiles> cd ..
instructor> docker ps
CONTAINER ID        IMAGE                          COMMAND                CREATED              STATUS              PORTS                                                   NAMES
7b847ca4554e        registry:2.0                   "registry cmd/regist   45 seconds ago       Up 45 seconds       0.0.0.0:5000->5000/tcp                                  instructor_dockerregistry_1
3704d3205eac        sameersbn/gitlab:7.10.4        "/app/init app:start   About a minute ago   Up About a minute   443/tcp, 0.0.0.0:10022->22/tcp, 0.0.0.0:10080->80/tcp   instructor_gitlab_1
66ac375ecd8d        sameersbn/postgresql:9.4       "/start"               2 minutes ago        Up 2 minutes        5432/tcp                                                instructor_postgresqlgitlab_1
b4a36e701386        sonatype/nexus:oss             "/bin/sh -c 'java      4 minutes ago        Up 4 minutes        0.0.0.0:8081->8081/tcp                                  instructor_nexus_1
5986b380732c        sameersbn/redis:latest         "/start"               4 minutes ago        Up 4 minutes        6379/tcp                                                instructor_redisgitlab_1
a041b58ceff1        instructor_httpserver:latest   "/run-apache.sh"       5 minutes ago        Up 5 minutes        0.0.0.0:8082->80/tcp                                    instructor_httpserver_1
----

Test if the servers are running:

. Docker Registry [http://localhost:5000/v2/]
+
image::images/registry-default-output.png[]
+
. Nexus Console [http://localhost:8081/content/groups/public/]
+
image::images/nexus-default-output.png[]
+
. Apache Webserver [http://localhost:8082/]
+
image::images/webserver-default-output.png[]
+
. Gitlab server [http://localhost:10080/]
+
image::images/gitlab-default-output.png[]


## Populate Gitlab with Ticket Monster Source Code
In order to allow a complete offline experience, we also host our own git repository for the demo application on the instructor machine.

NOTE: Gitlab must have completed his startup. It usually takes 3 minutes to do so.

Execute:

[source,text]
----
docker exec instructor_gitlab_1 bash -c "cd /home/git/data/repositories/root; git clone --bare https://github.com/rafabene/ticket-monster.git; chown git:git -R /home/git/data/repositories; cd /home/git/gitlab; sudo -u git -H bundle exec rake -v gitlab:import:repos RAILS_ENV=production"
----

This will show the output as:

[source, text]
----
Cloning into bare repository 'ticket-monster.git'...
Processing root/ticket-monster.git
 * Created ticket-monster (root/ticket-monster.git)
Done!
----

## Build TicketMonster from Source Code

1. Clone TicketMonster from the existing gitlab container

  git clone -b WildFly-docker-test http://root:dockeradmin@localhost:10080/root/ticket-monster.git

2. Build TicketMonster

  mvn -s settings.xml -f ticket-monster/demo/pom.xml -Ppostgresql clean package

3. Copy TicketMonster war to the Docker ticketmonster-pgsql-widlfly image folder

  cp ticket-monster/demo/target/ticket-monster.war dockerfiles/ticketmonster-pgsql-wildfly/

## Build Images

Build ``managed-widlfly'' and ``ticketmonster-pgsql-widlfly'' images

[source, text]
----
docker build -t "instructor/wildfly-management" dockerfiles/wildfly-management/
docker build -t "instructor/ticketmonster-pgsql-wildfly" dockerfiles/ticketmonster-pgsql-wildfly/
----

## Push Images to Registry

Put the following images to the local registry:

. ``jboss/wildfly''
. ``managed-wildfly''
. ``ticketmonster-pgsql-wildfly''
. ``postgres''
. ``modcluster''
. ``javaee7-hol''

These commands are available in https://github.com/arun-gupta/docker-java/blob/master/instructor/push-images-to-registry.sh[push-images-to-registry.sh].

[source, text]
----
# Wildfly
docker pull jboss/wildfly
docker tag jboss/wildfly localhost:5000/wildfly
docker push localhost:5000/wildfly

# Managed WildFly
docker tag instructor/wildfly-management localhost:5000/wildfly-management
docker push localhost:5000/wildfly-management

# Ticket-monster+PGSQ+WildFly
docker tag instructor/ticketmonster-pgsql-wildfly localhost:5000/ticketmonster-pgsql-wildfly
docker push localhost:5000/ticketmonster-pgsql-wildfly

# Postgres
docker pull postgres
docker tag postgres localhost:5000/postgres
docker push localhost:5000/postgres

# Modcluster
docker pull goldmann/mod_cluster
docker tag goldmann/mod_cluster localhost:5000/mod_cluster
docker push localhost:5000/mod_cluster

#Java EE 7 hol
docker pull arungupta/javaee7-hol
docker tag arungupta/javaee7-hol localhost:5000/javaee7-hol
docker push localhost:5000/javaee7-hol
----

## More information

If you need some extra information like:

- Updating the attendees instructions served by the instructor httpd server
- Backing up Nexus data container to a file

Please, check the link:extra.adoc[extra instructions].
